# タグ機能の追加

## 概要

Todo にタグを付与し、タグによる分類・フィルタリングを可能にする機能を追加します。この機能は複数の層（DB / API / UI）にまたがる変更が必要で、subagent の効果を実証する良いケーススタディとなります。

## 背景

- Todo を柔軟に分類したい
- 複数の視点（プロジェクト、優先度、カテゴリなど）で整理したい
- 期限や完了状態以外の軸でフィルタリングしたい

## ユーザーストーリー

### US-1: タグの作成と付与
**As a** ユーザー
**I want to** Todo にタグを付けられる
**So that** 柔軟に分類できる

**受入基準**
- Todo 作成時にタグを指定できる
- 既存の Todo にタグを追加できる
- 1つの Todo に複数のタグを付与できる
- タグ名は1文字以上20文字以下
- タグ名に使用できる文字: 英数字、日本語、ハイフン、アンダースコア
- 大文字小文字を区別しない（正規化される）
- 同じタグの重複付与はできない

### US-2: タグの表示
**As a** ユーザー
**I want to** Todo に付与されたタグを見られる
**So that** どのカテゴリに属するか把握できる

**受入基準**
- Todo 一覧でタグが視覚的に表示される
- タグは色分けされる（タグ名のハッシュ値から自動生成）
- タグをクリックすると該当タグでフィルタされる

### US-3: タグによるフィルタリング
**As a** ユーザー
**I want to** 特定のタグが付いた Todo だけを表示できる
**So that** 目的に応じた Todo リストを見られる

**受入基準**
- タグ一覧から選択してフィルタできる
- 複数タグでの AND/OR フィルタが可能
- フィルタ状態は URL に反映される（共有可能）
- フィルタ中でも Todo の追加・編集・削除ができる

### US-4: タグの削除
**As a** ユーザー
**I want to** Todo からタグを削除できる
**So that** 分類を修正できる

**受入基準**
- Todo 編集画面からタグを削除できる
- どの Todo からも使われていないタグは自動削除される
- タグ削除時に確認ダイアログは不要

## 技術要件

### データベース設計

#### Tag テーブル
```prisma
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique @db.VarChar(20)
  createdAt DateTime @default(now())
  todos     TodoTag[]
}
```

#### TodoTag テーブル（中間テーブル）
```prisma
model TodoTag {
  todoId String
  tagId  String
  todo   Todo   @relation(fields: [todoId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([todoId, tagId])
  @@index([todoId])
  @@index([tagId])
}
```

#### Todo テーブル（関連追加）
```prisma
model Todo {
  // 既存フィールド...
  tags TodoTag[]
}
```

### API エンドポイント

#### 1. タグ一覧取得
```
GET /api/tags
Response: { id, name, count }[]
```

#### 2. タグ作成（または取得）
```
POST /api/tags
Body: { name: string }
Response: { id, name }
```
- 既存タグの場合は既存のものを返す（正規化して比較）

#### 3. Todo へのタグ付与
```
POST /api/todos/:todoId/tags
Body: { tagNames: string[] }
Response: Todo（tags を含む）
```

#### 4. Todo からタグ削除
```
DELETE /api/todos/:todoId/tags/:tagId
Response: 204 No Content
```

#### 5. Todo 一覧取得（タグフィルタ対応）
```
GET /api/todos?tags=tag1,tag2&tagsMode=and
- tagsMode: "and" | "or" (default: "or")
```

#### 6. Todo 作成・更新（タグ対応）
```
POST /api/todos
PATCH /api/todos/:id
Body に tags: string[] を追加
```

### フロントエンド実装

#### コンポーネント
1. **TagInput** - タグ入力コンポーネント
   - オートコンプリート機能
   - Enter または , で確定
   - 既存タグの候補表示

2. **TagList** - タグ表示コンポーネント
   - タグのバッジ表示
   - クリックでフィルタ
   - × ボタンで削除

3. **TagFilter** - タグフィルタコンポーネント
   - 全タグ一覧表示
   - AND/OR 切り替え
   - クリアボタン

#### 状態管理
- 選択中のタグフィルタ
- AND/OR モード
- タグ候補リスト（キャッシュ）

### バリデーション

#### タグ名のルール
- 長さ: 1文字以上20文字以下
- 使用可能文字: `^[a-zA-Z0-9ぁ-んァ-ヶー一-龠\-_]+$`
- 前後の空白は trim
- 大文字小文字は正規化（小文字に統一）

#### エッジケース
- 空文字列のタグ → エラー
- 20文字超 → エラー
- 特殊文字（スペース、記号など）→ エラー
- 重複タグの付与 → 無視（冪等性）
- 存在しない Todo へのタグ付与 → 404

## 非機能要件

### パフォーマンス
- タグ一覧取得は100ms以内
- タグフィルタリングは200ms以内
- 1つの Todo に最大20個のタグ

### アクセシビリティ
- タグ追加フォームに適切な label
- キーボードでタグ削除可能（Backspace）
- スクリーンリーダーでタグ名が読み上げられる

### エラーハンドリング
- バリデーションエラーは具体的なメッセージ
- ネットワークエラー時のリトライ機能
- 楽観的 UI 更新（即座に反映、失敗時にロールバック）

## 実装の優先順位

### Phase 1: 基盤（必須）
1. DB schema 設計とマイグレーション
2. Tag CRUD API 実装
3. Todo-Tag 関連付け API 実装

### Phase 2: 基本機能（必須）
4. タグフィルタリング API
5. フロントエンド: TagInput コンポーネント
6. フロントエンド: TagList 表示

### Phase 3: 拡張機能（推奨）
7. フロントエンド: TagFilter コンポーネント
8. オートコンプリート機能
9. URL 連携（フィルタ状態の共有）

## テスト観点

### API テスト（Checker が実装）
- ✅ 正常系: タグ作成、付与、削除
- ✅ 境界値: 1文字、20文字、21文字（エラー）
- ✅ 異常系: 不正な文字、空文字、重複
- ✅ 関連性: Todo 削除時にタグ関連も削除
- ✅ フィルタ: AND/OR、複数タグ、存在しないタグ
- ✅ 正規化: 大文字小文字、前後空白

### UI テスト
- ✅ タグ入力: Enter/カンマで確定
- ✅ タグ削除: × ボタン、Backspace
- ✅ フィルタ: クリック、AND/OR切り替え
- ✅ エラー表示: バリデーションエラー

## リスク

### 技術的リスク
- **多対多リレーションの複雑さ** - Prisma での適切な実装が必要
- **N+1 問題** - タグを含む Todo 取得時のクエリ最適化
- **正規化ロジック** - 大文字小文字、Unicode 正規化の一貫性

### スコープリスク
- **タグの色管理** - 将来的にユーザーが色を選択したい可能性
- **タグの階層構造** - 将来的に親子関係が欲しくなる可能性

## 成功指標

### Subagent による分割効果
- Owner が5-7個のタスクに適切に分解できる
- 各タスクのコンテキストが独立している
- Checker が包括的なテストを追加できる

### 品質指標
- すべてのテストが通る
- lint / 型チェックが通る
- バグなく機能する

### コンテキスト管理
- 1タスクあたりのトークン数が適切な範囲
- タスク間の依存関係が明確
- 再実行が少ない

## 参考

類似機能の例:
- GitHub の Issue Labels
- Gmail のラベル機能
- Trello のタグ機能
